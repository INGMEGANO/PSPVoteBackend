generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.0.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Role {
  id       String  @id @default(uuid())
  name     String  @unique
  isActive Boolean @default(true)

  users User[]
}

model User {
  id       String @id @default(uuid())
  username String @unique
  password String

  roleId String
  role   Role   @relation(fields: [roleId], references: [id])

  leaderId String?
  leader   Leader? @relation(fields: [leaderId], references: [id])

  votacionesComoDigitador Votacion[] @relation("DigitadorVotaciones")

  consultasVotacion VotacionConsulta[]

  isActive Boolean @default(true)

  votacionStatusLogs VotacionStatusLog[]

  confirmacionesVoto VotacionConfirmacion[] @relation("ConfirmacionesPorUsuario")

  createdAt DateTime @default(now())
}

model Leader {
  id      String  @id @default(uuid())
  name    String
  phone   String?
  address String?

  //  Relaci贸n recursiva (l铆der recomendado por otro l铆der)
  recommendedById String?
  recommendedBy   Leader?  @relation("LeaderRecommendations", fields: [recommendedById], references: [id])
  recommendations Leader[] @relation("LeaderRecommendations")

  //  Relaciones
  users      User[]
  votaciones Votacion[]

  //  Relaci贸n de votaciones donde este l铆der es recomendado
  recommendedVotaciones Votacion[] @relation("RecommendedVotaciones")

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Audit {
  id         String   @id @default(uuid())
  tableName  String
  recordId   String
  oldValues  Json
  newValues  Json
  modifiedBy String
  modifiedAt DateTime @default(now())
}

model Votacion {
  id String @id @default(uuid())

  // Datos del votante
  nombre1   String
  nombre2   String?
  apellido1 String
  apellido2 String?
  cedula    String
  telefono  String?
  direccion String?
  barrio    String?

  puestoVotacion String?

  // Relaci贸n con l铆der
  leaderId String
  leader   Leader @relation(fields: [leaderId], references: [id])

  // L铆der recomendado para esta votaci贸n
  recommendedById String?
  recommendedBy   Leader? @relation("RecommendedVotaciones", fields: [recommendedById], references: [id])

  // Digitador que ingresa masivamente
  digitadorId String?
  digitador   User?   @relation("DigitadorVotaciones", fields: [digitadorId], references: [id])

  //  CONTROL REAL
  isActive       Boolean    @default(true)
  isDuplicate    Boolean    @default(false)
  duplicatedFrom String?
  duplicateOf    Votacion?  @relation("VotacionDuplicates", fields: [duplicatedFrom], references: [id])
  duplicates     Votacion[] @relation("VotacionDuplicates")

  programaId String?
  programa   Programa? @relation(fields: [programaId], references: [id])

  sedeId String?
  sede   SedePrograma? @relation(fields: [sedeId], references: [id])

  tipoId String?
  tipo   TipoVinculacion? @relation(fields: [tipoId], references: [id])

  esPago Boolean @default(false)

  planilla Int?

  statusLogs VotacionStatusLog[]

  consultas VotacionConsulta[]

  confirmacion VotacionConfirmacion?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cedula, leaderId])
}

model PuestoVotacion {
  id           String  @id @default(uuid())
  codUnic      String  @unique
  departamento String
  municipio    String
  puesto       String
  mujeres      Int
  hombres      Int
  total        Int
  mesas        Int
  comuna       String?
  direccion    String
  latitud      Decimal @db.Decimal(10, 7)
  longitud     Decimal @db.Decimal(10, 7)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Programa {
  id         String  @id @default(uuid())
  nombre     String  @unique
  tieneSedes Boolean @default(false)

  votaciones   Votacion[]
  SedePrograma SedePrograma[]
}

model SedePrograma {
  id     String @id @default(uuid())
  nombre String

  programaId String
  programa   Programa @relation(fields: [programaId], references: [id])

  votaciones Votacion[]

  @@unique([nombre, programaId])
}

model TipoVinculacion {
  id     String  @id @default(uuid())
  nombre String  @unique
  esPago Boolean @default(false)

  votaciones Votacion[]
}

model VotacionStatusLog {
  id          String   @id @default(uuid())
  votacionId  String
  userId      String
  action      String
  observation String?
  createdAt   DateTime @default(now())

  votacion Votacion @relation(fields: [votacionId], references: [id])
  user     User     @relation(fields: [userId], references: [id])
}

model VotacionConsulta {
  id String @id @default(uuid())

  votacionId String
  votacion   Votacion @relation(fields: [votacionId], references: [id], onDelete: Cascade)

  fuente       String?
  estado       String
  observacion  String?
  consultadoEn DateTime @default(now())

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  @@index([votacionId])
  @@index([estado])
}

model VotacionConfirmacion {
  id String @id @default(uuid())

  // Relaci贸n 1 a 1
  votacionId String   @unique
  votacion   Votacion @relation(fields: [votacionId], references: [id])

  // Datos de confirmaci贸n
  codigoVotacion String
  imagen         String

  confirmadoPorId String?
  confirmadoPor   User?   @relation("ConfirmacionesPorUsuario", fields: [confirmadoPorId], references: [id])

  confirmado Boolean @default(true)

  createdAt DateTime @default(now())
}
